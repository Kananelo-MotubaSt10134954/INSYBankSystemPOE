version: 2.1

orbs:
  node: circleci/node@5.2.0 # Node.js orb for dependency management
  sonarcloud: sonarsource/sonarcloud@1.2.1 # SonarCloud orb for scanning

jobs:
  build-and-scan:
    docker:
      - image: cimg/node:20.11 # Node.js 20 for 2025 compatibility
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: client
          cache-path: client/node_modules
      - node/install-packages:
          pkg-manager: npm
          app-dir: server
          cache-path: server/node_modules
      - run:
          name: Build React App
          command: cd client && npm run build
      - run:
          name: Run Tests (Frontend)
          command: cd client && npm run test -- --coverage || true # Continue on test failure
          environment:
            CI: true
      - run:
          name: Run Tests (Backend)
          command: cd server && npm run test || true # Add backend tests if available
      - sonarcloud/scan:
          sonar_token: ${SONAR_TOKEN}
          sonar_host_url: ${SONAR_HOST_URL}
          working_directory: .
          extra_args: -Dsonar.javascript.node.maxspace=4096 # Increase memory for large projects

workflows:
  sonar-scan-workflow:
    jobs:
      - build-and-scan
